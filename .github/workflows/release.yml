name: Release toon4j

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (without v prefix, e.g., 0.1.0)'
        required: true
        type: string
      next_version:
        description: 'Next SNAPSHOT version (e.g., 0.2.0-SNAPSHOT)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  release:
    name: Create Release and Deploy to Maven Central
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version and next SNAPSHOT
        id: get_version
        run: |
          VERSION="${{ inputs.version }}"
          TAG="v${VERSION}"
          NEXT_VERSION="${{ inputs.next_version }}"
          IS_PRERELEASE="${{ inputs.prerelease }}"

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          echo " Release version: $VERSION"
          echo "Ô∏è Tag: $TAG"
          echo " Next version: $NEXT_VERSION"
          echo " Pre-release: $IS_PRERELEASE"

      - name: Validate version format
        run: |
          # Validate release version
          if [[ ! "${{ steps.get_version.outputs.VERSION }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo " Invalid release version format: ${{ steps.get_version.outputs.VERSION }}"
            echo "Expected format: X.Y.Z or X.Y.Z-qualifier (e.g., 1.0.0 or 1.0.0-beta1)"
            exit 1
          fi
          echo " Release version format is valid"

          # Validate next SNAPSHOT version
          if [[ ! "${{ steps.get_version.outputs.NEXT_VERSION }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+-SNAPSHOT$ ]]; then
            echo " Invalid next SNAPSHOT version format: ${{ steps.get_version.outputs.NEXT_VERSION }}"
            echo "Expected format: X.Y.Z-SNAPSHOT (e.g., 0.2.0-SNAPSHOT)"
            exit 1
          fi
          echo " Next SNAPSHOT version format is valid"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: Configure Git user
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "ricken.bazolo@gmail.com"

      - name: Update version in pom.xml
        run: |
          echo "Setting version to ${{ steps.get_version.outputs.VERSION }}"
          mvn versions:set -DnewVersion=${{ steps.get_version.outputs.VERSION }} -DgenerateBackupPoms=false

      - name: Run full test suite
        run: mvn clean test -B

      - name: Commit release version and create tag
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "ricken.bazolo@gmail.com"

          # Only commit if there are changes
          if [[ -n $(git status --porcelain) ]]; then
            git add pom.xml
            git commit -m "chore: release version ${{ steps.get_version.outputs.VERSION }}"
            git push origin HEAD:main
          else
            echo "No changes to commit (version already correct)"
          fi

          # Create and push tag
          git tag -a "${{ steps.get_version.outputs.TAG }}" -m "Release version ${{ steps.get_version.outputs.VERSION }}"
          git push origin "${{ steps.get_version.outputs.TAG }}"

      - name: Deploy to Maven Central
        env:
          MAVEN_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.CENTRAL_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: mvn deploy -P release -DskipTests -B

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.TAG }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ##Release ${{ steps.get_version.outputs.VERSION }}

            ${{ inputs.release_notes || 'No release notes provided.' }}

            ---

            ### Maven Central

            ```xml
            <dependency>
                <groupId>com.rickenbazolo</groupId>
                <artifactId>toon4j</artifactId>
                <version>${{ steps.get_version.outputs.VERSION }}</version>
            </dependency>
            ```

            ### Gradle
            ```groovy
            implementation 'com.rickenbazolo:toon4j:${{ steps.get_version.outputs.VERSION }}'
            ```

            ### Links
            - [Maven Central](https://central.sonatype.com/artifact/com.rickenbazolo/toon4j/${{ steps.get_version.outputs.VERSION }})
            - [Documentation](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.TAG }}/README.md)
            - [Changelog](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.TAG }}/CHANGELOG.md)
          draft: false
          prerelease: ${{ steps.get_version.outputs.IS_PRERELEASE }}
          files: |
            target/*.jar
            target/*.pom
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update to next SNAPSHOT version
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "ricken.bazolo@gmail.com"
          echo "Updating to next SNAPSHOT version: ${{ steps.get_version.outputs.NEXT_VERSION }}"
          mvn versions:set -DnewVersion=${{ steps.get_version.outputs.NEXT_VERSION }} -DgenerateBackupPoms=false

          # Only commit if there are changes
          if [[ -n $(git status --porcelain) ]]; then
            git add pom.xml
            git commit -m "chore: bump version to ${{ steps.get_version.outputs.NEXT_VERSION }} [skip ci]"
            git push origin HEAD:main
          else
            echo "No changes to commit (version already correct)"
          fi

      - name: Summary
        run: |
          echo "## Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Released version**: ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Next version**: ${{ steps.get_version.outputs.NEXT_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.get_version.outputs.TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release**: ${{ steps.get_version.outputs.IS_PRERELEASE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- [Maven Central](https://central.sonatype.com/artifact/com.rickenbazolo/toon4j/${{ steps.get_version.outputs.VERSION }})" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- The artifact should be available on Maven Central within 15-30 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- The pom.xml has been automatically updated to ${{ steps.get_version.outputs.NEXT_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Update documentation and announce the release!" >> $GITHUB_STEP_SUMMARY
